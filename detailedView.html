<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detaljni pregled nekretnine</title>

  <link rel="stylesheet" href="style.css">

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-storage-compat.js"></script>

  <!-- shared logic (initialises Firebase once for the whole page) -->
  <script src="script.js"></script>

  <!-- extra CSS for the picture carousel -->
  <style>
    .carousel-track{display:flex;overflow-x:scroll;scroll-snap-type:x mandatory;width:80%}
    .carousel-slide{flex:0 0 auto;scroll-snap-align:center;width:600px;height:400px}
    .carousel-slide img{width:100%;height:100%;object-fit:cover}
    .carousel-dots{text-align:center;margin-top:.5rem}
    .carousel-dots span{display:inline-block;width:10px;height:10px;margin:0 4px;border-radius:50%;background:#ccc;cursor:pointer}
    .active-dot{background:#333}
    .carousel-arrow{position:absolute;top:50%;transform:translateY(-50%);font-size:1.8rem;cursor:pointer;background:rgba(255,255,255,.5);border-radius:50%;padding:.2rem .5rem;user-select:none;z-index:5}
    #arrowLeft{display: none;}#arrowRight{display: none;}
  </style>
</head>
<body>

  <div id="navbarContainer"></div>

  <!-- MAIN CONTENT -->
  <div class="detail-container" style="margin-top:80px;">
    <!-- carousel -->
    <div class="carousel-wrapper" style="position:relative;width:60%;">
      <div class="carousel-track" id="carouselTrack"></div>
      <div class="carousel-dots"  id="carouselDots"></div>
    </div>

    <!-- info -->
    <div class="info">
      <!-- main title: property title or address -->
      <h2 id="detailTitle"></h2>
      <!-- city/location -->
      <div id="detailLocation" class="location"></div>
      <!-- formatted price in EUR with spacing (e.g. 300 000€) -->
      <div id="detailPrice"   class="price"></div>
      <!-- status indicator: Sold or Available -->
      <div id="detailStatus"  class="status"></div>
      <!-- bed/bath specs -->
      <div id="detailSpecs"   class="details"></div>
      <!-- full address -->
      <div id="detailAddress" class="address"></div>
      <a href="contact.html" class="btn-contact">Kontaktiraj nas</a>
    </div>
  </div>

  <!-- MAP -->
  <iframe id="mapFrame" class="detail-map"
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=Zagreb+Croatia&output=embed"></iframe>

  <!-- FOOTER -->
  <footer>
    <div class="footer-content" id="footerContainer"></div>
  </footer>

  <!-- PAGE‑SPECIFIC SCRIPT (requires global db from script.js) -->
  <script>
    /* inject navbar + footer */
    Promise.all([
      fetch("navbar.html").then(r=>r.text()),
      fetch("footer.html").then(r=>r.text())
    ]).then(([nav,foot])=>{
      document.getElementById("navbarContainer").innerHTML = nav;
      document.getElementById("footerContainer").innerHTML = foot;
    });

    /* refs */
    const track = document.getElementById("carouselTrack");
    const dots  = document.getElementById("carouselDots");
    const left  = document.getElementById("arrowLeft");
    const right = document.getElementById("arrowRight");

    /* URL params */
    const p     = new URLSearchParams(location.search);
    const docId = p.get("docId");

    if(docId){
      db.doc(`properties/${docId}`).get().then(s=>{
        if(!s.exists){alert("Nekretnina nije pronađena");return;}
        render(s.data());
      });
    }else{
      /* fallback for old links */
      render({
        address: p.get("address") || "N/A",
        price  : p.get("price")   || "-",
        bedAmount : p.get("beds") || "-",
        bathAmount: p.get("baths")|| "-",
        images: (p.get("img")||"").split("|").filter(Boolean)
      });
    }

    function render(d) {
  // Convert image URIs (or use placeholder)
  const images = (d.images?.length ? d.images : [PLACEHOLDER]).map(toHttps);

  track.innerHTML = dots.innerHTML = "";
  images.forEach((url, i) => {
    track.insertAdjacentHTML("beforeend",
      `<div class="carousel-slide"><img src="${url}" alt=""></div>`);
    dots.insertAdjacentHTML("beforeend",
      `<span class="${i ? "" : "active-dot"}"></span>`);
  });

  // Create simple carousel handlers only if arrow elements exist
  const slides = [...track.children];
  const indicators = [...dots.children];
  let idx = 0;
  function go(i) {
    track.scrollTo({ left: (600 + 20) * i, behavior: "smooth" });
    indicators[idx].classList.remove("active-dot");
    indicators[i].classList.add("active-dot");
    idx = i;
  }
  // Check for null before assigning click handlers
  if (left) left.onclick  = () => go((idx ? idx : slides.length) - 1);
  if (right) right.onclick = () => go((idx + 1) % slides.length);
  indicators.forEach((dot, i) => dot.onclick = () => go(i));

  // Basic information
  // Use title or address for the heading
  const title = d.title || d.address || "";
  document.getElementById("detailTitle").textContent = title;

  // Format the price with euro and spacing (using the helper from script.js)
  document.getElementById("detailPrice").textContent =
    d.price ? formatPriceEUR(d.price) : "-";

  // Beds and baths
  const beds  = d.bedAmount ?? "-";
  const baths = d.bathAmount ?? "-";
  document.getElementById("detailSpecs").textContent =
    `${beds} kreveta • ${baths} kupatila`;

  // Full address (includes city if available)
  const addressParts = [];
  if (d.address) addressParts.push(d.address);
  if (d.cityName) addressParts.push(d.cityName);
  document.getElementById("detailAddress").textContent =
    addressParts.join(", ") || "-";

  // Map
  if (d.address) {
    document.getElementById("mapFrame").src =
      `https://www.google.com/maps?q=${encodeURIComponent(d.address)}&output=embed`;
  }
}


    /**
     * Format a numeric price into Croatian/European format with spaces
     * between thousands and an euro symbol appended, e.g. 300000 → '300 000€'.
     * If the value cannot be parsed as a number, it returns the original
     * input unchanged.
     * @param {number|string} value
     * @returns {string}
     */
    function formatPriceEUR(value) {
      const num = Number(value);
      if (!isFinite(num)) return String(value || '');
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + '€';
    }
  </script>
</body>
</html>
